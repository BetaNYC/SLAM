<!DOCTYPE html>
<html>
    <head>
        <title>SLA Mapper | CARTO</title>
        <meta name="viewport" content="initial-scale=1.0">
            <meta charset="utf-8">
            <link href="https://fonts.googleapis.com/css?family=Lato:400,600,700|Open+Sans:300,400,600" rel="stylesheet">
			<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Playfair+Display" />
            <!-- Include Leaflet -->
            <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
            <link href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" rel="stylesheet">
            <!-- Include CARTO.js -->
            <script src="https://libs.cartocdn.com/carto.js/v4.1.2/carto.min.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.min.js"></script>
            <link href="https://carto.com/developers/carto-js/examples/maps/public/style.css" rel="stylesheet">
			<link href="css/style.css" rel="stylesheet">
			<script type="text/javascript" src="scripts/main.js"></script>
			<meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0"/>
			<!-- Global site tag (gtag.js) - Google Analytics -->
			<script async src="https://www.googletagmanager.com/gtag/js?id=UA-58265408-4"></script>
			<script>
			  window.dataLayer = window.dataLayer || [];
			  function gtag(){dataLayer.push(arguments);}
			  gtag('js', new Date());

			  gtag('config', 'UA-58265408-4');
			</script>
    </head>
    
    <body>
        <div id="map"></div>

        <!-- title, legend, and search controls -->
		<aside class="toolbox_left">
			<div class="box">
			
				<!-- title -->
                <header>
                    <h1>SLA Mapper (SLAM)</h1>
					<div id="about">
						<figure class="figure">
							<img class="logo" src="images/BetaNYC_short_white_on_blue.png"/>
							<figcaption class="logo_caption">A BetaNYC Tool</figcaption>
						</figure>
						<h5 class="lighter">SLA Mapper (SLAM) is a tool that aggregates data that community boards often have to gather in order to review liquor license applications and sidewalk café applications. Displaying this information in a unified view saves community boards considerable time and resources.</h5>
					</div>
					
                </header>
				<div class="separator"></div>
				
				<!-- instructions -->
					<h4>Instructions</h4>
                    <h5 class="lighter">Click on a map feature to learn more about an establishment's liquor license, sidewalk café license, restaurant health grades, or 311 complaints.</h5>
				<div class="separator"></div>
				
				<!-- legend -->
				<div id="controls">
					<ul class="actions">
						<li>
							<label class="switch">
								<input id="sla" type="checkbox" name="style" onchange="show_sla()" checked>
								<span class="slider"></span>
							</label>
							<h5>State Liquor Authority Licenses</h5>
						</li>
						<li>
							<img class="icon" src = "https://s3.amazonaws.com/com.cartodb.users-assets.production/production/betanyc/assets/20180629205705bar-15.svg"/><p class = "legend_text">Expiring before 2019</p>
							<img class="icon" src = "https://s3.amazonaws.com/com.cartodb.users-assets.production/production/betanyc/assets/20180629205836bar-15.svg"/><p class = "legend_text">Expiring after 2019</p>
						</li>
						<li>
							<label class="switch">
								<input id="swc" type="checkbox" name="style" onchange="show_swc()" checked>
								<span class="slider"></span>
							</label>
							<h5>Sidewalk Café Licenses</h5>
						</li>
						<li>
							<img class="icon" src = "https://s3.amazonaws.com/com.cartodb.users-assets.production/production/betanyc/assets/20180629210223picnic-site-15.svg"/><p class = "legend_text">Active</p>
							<img class="icon" src = "https://s3.amazonaws.com/com.cartodb.users-assets.production/production/betanyc/assets/20180629210143picnic-site-15.svg"/><p class = "legend_text">Inactive</p>
						</li>
						<li>
							<label class="switch">
								<input id="311" type="checkbox" name="style" onchange="show_311()" checked>
								<span class="slider"></span>
							</label>
							<h5>311 Complaints Since 2017</h5>
						</li>
						<li>
							<p class="legend_text"><em>*Filtered to those made at club/bar/restaurant</em></p>
						</li>
						<li>
							<img class="icon" src = "https://s3.amazonaws.com/com.cartodb.users-assets.production/production/betanyc/assets/20180629210011circle-11.svg"/><p class = "legend_text">Noise</p>
							<img class="icon" src = "https://s3.amazonaws.com/com.cartodb.users-assets.production/production/betanyc/assets/20180629210053circle-11.svg"/><p class = "legend_text">Drinking</p>
						</li>
						<li>
							<label class="switch">
								<input id="dohmh" type="checkbox" name="style" onchange="show_dohmh()" checked>
								<span class="slider"></span>
							</label>
							<h5>Restaurant Health Grades</h5>
						</li>
						<li>
							<img class="icon" src = "https://s3.amazonaws.com/com.cartodb.users-assets.production/production/betanyc/assets/20180629205921embassy-15.svg"/><p class = "legend_text">Restaurant</p>
						</li>
					</ul>
					</div>
					<div class="separator"></div>
					
					<!-- location search -->
						<h4>Search</h4>
						<div class="select_custom">
						<select id="boro" >
							<option value="Borough">Select a Borough</option>
  							<option value="Bronx">Bronx</option>
  							<option value="Brooklyn">Brooklyn</option>
  							<option value="Manhattan">Manhattan</option>
  							<option value="Queens">Queens</option>
							<option value="Staten Island">Staten Island</option>
						</select>
						<div class="select_arrow"></div>
						</div>
						<input id="address" placeholder="Enter a NYC Address" onfocus="this.value=''" type="text" name="address" value="" class="search_bar"><br/>
						
						<input type="submit" value="Search" onclick="set_address()">
						<div id="no_results">
							<p>No results found.</p>
						</div>
				</div>
		</aside>
		
        <aside class="toolbox">
			<div id="info_box" class="box clearfix">
					<!-- Main info -->
					<div id="info"></div>
					
					<!-- 311 info -->
					<canvas id="descriptor_chart"></canvas>
					<canvas id="year_chart"></canvas>
					
					<!-- source info -->
					<div id="source"></div>
					<a href="#" onclick="toggle_visibility('info_box');" class="close-button">Close Window</a>
			</div>
			<footer class="js-footer"></footer>
        </aside>
		
        
        <script>
			//set map view
            const map = L.map('map').setView([40.73, -74], 18);
            map.scrollWheelZoom.disable();
			
			//set basemap
            L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                        maxZoom: 18
            }).addTo(map);
			
			//connect to Carto
            const client = new carto.Client({
                apiKey: '0cdd88f5e816766aec13f416ec14b633e6ecb4b6',
                username: 'betanyc'
            });
			
			//store API key for later SQL queries
            var api_key = '0cdd88f5e816766aec13f416ec14b633e6ecb4b6';
			
			//query SLA data source from Carto and stack multiple entries at the same location:
			const source_sla = new carto.source.SQL(`WITH
				m AS (
					SELECT array_agg(cartodb_id) id_list, the_geom_webmercator, ST_Y(the_geom_webmercator) y
					FROM liquor_authority_quarterly_list_of_active_licenses WHERE agency_zone_office_number = 1 AND (license_type_code = 'OP' OR license_type_code = 'SW' OR license_type_code = 'SB' OR license_type_code = 'SL' OR license_type_code = 'VL' OR license_type_code = 'RL' OR license_type_code = 'HL' OR license_type_code = 'CL' OR license_type_code = 'CT' OR license_type_code = 'EL' OR license_type_code = 'TL' OR license_type_code = 'CR' OR license_type_code = 'RW' OR license_type_code = 'HW' OR license_type_code = 'CW' OR license_type_code = 'TW' OR license_type_code = 'WC' OR license_type_code = 'EB' OR license_type_code = 'MR')
					GROUP BY the_geom_webmercator
					ORDER BY y DESC),
				f AS (
					SELECT  generate_series(1, array_length(id_list,1)) p, unnest(id_list) cartodb_id, the_geom_webmercator
					FROM m)
				SELECT  ST_Translate(f.the_geom_webmercator,0,f.p*5) the_geom_webmercator, f.cartodb_id, q.license_serial_number, q.premises_name, q.doing_business_as_dba, q.actual_address_of_premises_address1, q.zip, q.license_certificate_number, q.license_type_name, q.license_original_issue_date, q.license_effective_date, q.license_expiration_date, EXTRACT(year from to_date(q.license_expiration_date, 'MM/DD/YYYY')) AS expiration_year
					FROM f, liquor_authority_quarterly_list_of_active_licenses q
					WHERE f.cartodb_id = q.cartodb_id`
            );
			
			//query 311 data source from Carto and stack multiple entries at the same location:
			const source_311 = new carto.source.SQL(`WITH
				s AS (
					SELECT ROW_NUMBER() OVER(ORDER BY to_timestamp(created_date, 'MM/DD/YYYY') ASC) rownum, the_geom_webmercator, cartodb_id
					FROM club_bar_restaurant_complaints_since_jan_1_2017),
				m AS (
					SELECT array_agg(cartodb_id ORDER BY rownum) id_list, the_geom_webmercator, ST_Y(the_geom_webmercator) y
					FROM s
					GROUP BY the_geom_webmercator
					ORDER BY y DESC),
				f AS (
					SELECT  generate_series(1, array_length(id_list,1)) p, unnest(id_list) cartodb_id, the_geom_webmercator
					FROM m)
				SELECT  ST_Translate(f.the_geom_webmercator,0,f.p*3) the_geom_webmercator, f.cartodb_id, q.complaint_type, q.descriptor, q.created_date, q.incident_address, q.intersection_street_1, q.intersection_street_2, q.location geometry
					FROM f, club_bar_restaurant_complaints_since_jan_1_2017 q
					WHERE f.cartodb_id = q.cartodb_id
			`);
			
			//query sidewalk café data source from Carto and stack multiple entries at the same location:
			const source_swc = new carto.source.SQL(`
				 SELECT * FROM sidewalk_caf_licenses_and_applications
			`);
			
			//query health inspection data source from Carto and stack multiple entries at the same location:
			const source_dohmh = new carto.source.SQL(`WITH
				m AS (
					SELECT array_agg(cartodb_id) id_list, the_geom_webmercator, ST_Y(the_geom_webmercator) y
					FROM dohmh_inspections
					GROUP BY the_geom_webmercator
					ORDER BY y DESC),
				f AS (
					SELECT  generate_series(1, array_length(id_list,1)) p, unnest(id_list) cartodb_id, the_geom_webmercator
					FROM m)
				SELECT  ST_Translate(f.the_geom_webmercator,0,f.p*5) the_geom_webmercator, f.cartodb_id, q.camis, q.dba, q.building, q.street
					FROM f, dohmh_inspections q
					WHERE f.cartodb_id = q.cartodb_id
			`);
			
			//Style the SLA data and color differently if expiring this year
            const style_sla = new carto.style.CartoCSS(`
                #layer {
                    marker-width: 20;
                    marker-fill-opacity: 0.9;
                    marker-file: url('https://s3.amazonaws.com/com.cartodb.users-assets.production/maki-icons/bar-18.svg');
					marker-allow-overlap: true;
					marker-line-width: 1;
					marker-line-color: #FFFFFF;
					marker-line-opacity: 1;
				}
				#layer [expiration_year <= 2018]{
                    marker-fill: #e10012;
				}
				#layer [expiration_year > 2018]{
					marker-fill: #e34dee;
				}
				#layer [zoom > 16]{
					marker-width: 20;
				}
				#layer [zoom <= 16]{
				  marker-width: 15;
				}
				#layer [zoom <= 15]{
				  marker-width: 13;
				}
				#layer [zoom <= 14]{
				  marker-width: 8;
				}
				#layer [zoom <= 12]{
				  marker-width: 4;
				}
            `);
			
			//Style the 311 data and color different complaint tyles differently
            const style_311 = new carto.style.CartoCSS(`
				#layer {
					marker-fill: #4d88ee;
					marker-fill-opacity: 0.9;
					marker-allow-overlap: true;
					marker-line-width: 0.25;
					marker-line-color: #FFFFFF;
					marker-line-opacity: 1;
				}
				#layer[complaint_type="Drinking"] {
					marker-fill: #3622b9;
				}
				#layer[complaint_type="Noise - Commercial"] {
					marker-fill: #4d88ee;
				}
				#layer [zoom > 16]{
					marker-width: 7;
				}
				#layer [zoom <= 16]{
				  marker-width: 5;
				}
				#layer [zoom <= 15]{
				  marker-width: 4;
				}
				#layer [zoom <= 14]{
				  marker-width: 3;
				}
				#layer [zoom <= 12]{
				  marker-width: 2;
				}

			`);
			
			//Style the sidewalk café data and color inactive licenses differently
			const style_swc = new carto.style.CartoCSS(`
				#layer {
				   marker-width: 18;
				   marker-fill-opacity: 0.9;
				   marker-file: url('https://s3.amazonaws.com/com.cartodb.users-assets.production/production/betanyc/assets/20180612173650picnic-site-15.svg');
				   marker-allow-overlap: true;
				   marker-line-width: 0.25;
				   marker-line-color: #FFFFFF;
				   marker-line-opacity: 1;
				}
				#layer [zoom > 16]{
					marker-width: 20;
				}
				#layer [zoom <= 16]{
				  marker-width: 15;
				}
				#layer [zoom <= 15]{
				  marker-width: 13;
				}
				#layer [zoom <= 14]{
				  marker-width: 8;
				}
				#layer [zoom <= 12]{
				  marker-width: 4;
				}
			   	#layer [lic_status = 'Active']{
				   marker-fill: #07d91c;
			   	}
			   	#layer [lic_status = 'Inactive']{
				   marker-fill: #227527;
			   	}
			   `);
			   
			   //Style the health inspection data
			   const style_dohmh = new carto.style.CartoCSS(`
			   #layer{
				  marker-fill: #ff8300;
				  marker-fill-opacity: 0.9;
				  marker-file: url('https://s3.amazonaws.com/com.cartodb.users-assets.production/maki-icons/embassy-18.svg');
				  marker-allow-overlap: true;
				  marker-line-width: 1;
				  marker-line-color: #FFFFFF;
				  marker-line-opacity: 1;
				}
				#layer [zoom > 16]{
					marker-width: 20;
				}
				#layer [zoom <= 16]{
				  marker-width: 15;
				}
				#layer [zoom <= 15]{
				  marker-width: 13;
				}
				#layer [zoom <= 14]{
				  marker-width: 8;
				}
				#layer [zoom <= 12]{
				  marker-width: 4;
				}

			   `);
			
            const layer_sla = new carto.layer.Layer(source_sla, style_sla, {
                featureClickColumns: ['premises_name', 'doing_business_as_dba', 'license_type_name', 'license_original_issue_date', 'license_effective_date', 'license_expiration_date', 'license_serial_number', 'actual_address_of_premises_address1', 'zip']
            });
			
            const layer_311 = new carto.layer.Layer(source_311, style_311, {
                featureOverColumns: ['geometry','incident_address','intersection_street_1','intersection_street_2','created_date','descriptor','complaint_type']
            });
			
			const layer_swc = new carto.layer.Layer(source_swc, style_swc, {
				featureOverColumns: ['license_nbr','lic_status','business_name','business_name2','building','street','swc_type', 'swc_sq_ft', 'swc_tables', 'swc_chairs', 'community_district','expiration_date', 'issuance','issuance_dd','cb','cb_dd', 'app_id', 'app_swc_type', 'app_sq_ft', 'app_tables', 'app_chairs','intake_dd' ]
			});
			const layer_dohmh = new carto.layer.Layer(source_dohmh, style_dohmh, {
				featureOverColumns: ['camis','dba', 'building','street' ]
			});
			
			//variables for charts
			var ctx;
			var ctx2;
			var descriptor_chart;
			var year_chart;
			
			//plug-in so that data labels appear on each dot of the line charts (the rent-stabilized units by year chart and the 311 complaints over time chart)
			//see: http://www.chartjs.org/samples/latest/advanced/data-labelling.html
			var LabelsPlugin = {afterDatasetsDraw: function(chart) {
					var ctx = chart.ctx;
					chart.data.datasets.forEach(function(dataset, i) {
						var meta = chart.getDatasetMeta(i);
						if (!meta.hidden) {
							meta.data.forEach(function(element, index) {
								// Draw the text in black, with the specified font
								ctx.fillStyle = 'rgb(100, 100, 100)';
								var fontSize = 10;
								var fontStyle = 'normal';
								var fontFamily = 'Helvetica Neue';
								ctx.font = Chart.helpers.fontString(fontSize, fontStyle, fontFamily);
								
								if (dataset.data[index] != null)
									dataNum = dataset.data[index];
								else
									dataNum = 0;
								// Just naively convert to string for now
								var dataString = dataNum.toString();
								// Make sure alignment settings are correct
								ctx.textAlign = 'center';
								ctx.textBaseline = 'middle';
								var padding = -15;
								var position = element.tooltipPosition();
								
								if (dataString != 0) {
									ctx.fillText(dataString, position.x, position.y - (fontSize / 2) - padding);
								}
							});
						}
					});
				}}
			
			//add layer to map
			client.addLayer(layer_311);
			
			//set pop-up content when hovering over a feature
			layer_311.on('featureOver', featureEvent =>{
				let dateDescriptor = '';
				
				dateDescriptor += `<div class="widget">`;
				//check if there is an incident address listed; if not concatenate the data in fields intersection1 and intersection2 to create an address
				if (featureEvent.data.incident_address!='')
					dateDescriptor += `<p class = "bold">${featureEvent.data.incident_address}</p>`;
				else
					dateDescriptor += `<p class = "bold">${featureEvent.data.intersection_street_1}, ${featureEvent.data.intersection_street_2}</p>`;
				dateDescriptor += `<p>Complaint Type: ${featureEvent.data.complaint_type}</p><p>Descriptor: ${featureEvent.data.descriptor}</p><p>Date: ${featureEvent.data.created_date}</p>`;
				popup.setContent(dateDescriptor);
				popup.setLatLng(featureEvent.latLng);
				if (!popup.isOpen()) {
					popup.openOn(map);
				}
			});
			
			layer_311.on('featureClicked', featureEvent => {
				
				//variables for the innerHTML content that will be filled into each div in the infobox
				let content = '';
				let source = '';
				
				//variables to store the descriptors of complaints and number of complaints in that descriptor for the selected location
				let descriptor_arr = {};
				let descriptor_labels = [];
				let descriptor_data = [];
				let descriptor_colors = [];
				
				//variables to store the years of complaints and number of complaints in that year for the selected location
				let year_arr = {};
				let year_labels = [];
				let year_data = [];
				let year_colors = [];
				
				
				//clear and destroy previous charts
				if (typeof descriptor_chart !== 'undefined'){
					descriptor_chart.clear();
					descriptor_chart.destroy();
				}
						 
				if (typeof year_chart !== 'undefined'){
					year_chart.clear();
					year_chart.destroy();
				}
				
				
				//query 311 complaint data made about bar/club/restaurant since 2017 (stored in carto) at the selected location; select, complaint type, descriptor, and year
				var url = "https://betanyc.carto.com/api/v2/sql/?q=SELECT cartodb_id, descriptor, created_date, EXTRACT(year from to_date(created_date, 'MM/DD/YYYY')) AS created_year FROM club_bar_restaurant_complaints_since_jan_1_2017 WHERE location='"+featureEvent.data.geometry+"'&api_key="+api_key;
				
				//variable to count complaints
				let complaints_count = 0;
				
				fetch(url)
				.then(function(response) {
					return response.json();
				})
				.then(function(geom_data) {
					complaints_count = geom_data.rows.length;
					
					//if there is an incident address listed in the dataset at that location list it; otherwise concatenate the strings in intersection1 and intersection2 of the dataset
					if (featureEvent.data.incident_address!=''){
						content += `<h4 class = "bold">${featureEvent.data.incident_address}</h4>`;
					}

					else {
						content += `<h4 class = "bold">${featureEvent.data.intersection_street_1}, ${featureEvent.data.intersection_street_2}</h4>`;
					}
					
					// list total number of complaints
					content += `<div class="separator"></div>
					<h5 class = "lighter">Total Number of Complaints: ${complaints_count}</h5>`;

					//store unique descriptors in the resulting data in an array and count the number of complaints for each of those descriptors
					for (var i = 0; i < complaints_count; i++) {
						descriptor_arr[geom_data.rows[i].descriptor] = 1 + (descriptor_arr[geom_data.rows[i].descriptor] || 0);
					}
					
					descriptor_labels = Object.keys(descriptor_arr);
					descriptor_data = Object.values(descriptor_arr);
					
					//assign random colors to each descriptor
					for (var i = 0; i < descriptor_labels.length; i++) {
						descriptor_colors.push('#' + (Math.random().toString(16) + '0000000').slice(2,8));
					}
					
					//create pie chart of descriptors
					ctx = document.getElementById("descriptor_chart").getContext('2d');
					descriptor_chart = new Chart(ctx, {
						type: 'pie',
						data: {
							labels: descriptor_labels,
							datasets: [{
										backgroundColor: descriptor_colors,
										data: descriptor_data
									 }]
						},
						options: {
							title: {
            					display: true,
            					text: 'Complaints by Descriptor'
        					},
							legend: {
								display: true,
								labels: {
									fontSize: 10
								},
								position:'right',
								onClick: null,
								fullWidth: true

							}
						}
					});
				   
				   //store unique years in the resulting data in an array and count the number of complaints for each of those years
					for (var i = 0; i < complaints_count; i++) {
						year_arr[geom_data.rows[i].created_year] = 1 + (year_arr[geom_data.rows[i].created_year] || 0);
					}
					
					year_labels = Object.keys(year_arr);
					year_data = Object.values(year_arr);
					
					//create bar chart of complaints per year
					ctx2 = document.getElementById("year_chart").getContext('2d');
					year_chart = new Chart(ctx2,{
						type: 'line',
						plugins: LabelsPlugin,
						data: {
							labels: year_labels,
							datasets: [{
								borderColor: '#4d88ee',
								data: year_data
							}]
						},
						options: {
							legend: {
								display: false
							},
							scales: {
            					yAxes: [{
									ticks: {
										beginAtZero:true,
										fontSize: 10
									},
									display: true,
									scaleLabel: {
										display: true,
										labelString: '# of Complaints',
										fontSize: 10
									}
								}],
								xAxes: [{
									ticks: {
										fontSize: 10
									},
									display: true,
									scaleLabel: {
										display: true,
										labelString: 'Year',
										fontSize: 10
									}
								}],
							},
							title: {
            					display: true,
            					text: 'Complaints by Year'
        					}
						}
					});
					
					//add source information
					source += `<div class="separator"></div><h6>Source: <a href='https://data.cityofnewyork.us/Social-Services/311-Service-Requests-from-2010-to-Present/erm2-nwe9/data'>311 Service Requests from 2010 to Present</a></h6><h6>Data was filtered to complaints at a club/restaurant/bar made since January 1, 2017. Data is updated daily.</h6>`;
					
					//set the info_box to display as block
					show_info_box();
					
					//display the charts
					if (document.getElementById('descriptor_chart').style.display = 'none')
						document.getElementById('descriptor_chart').style.display = 'block';
					if (document.getElementById('year_chart').style.display = 'none')
						document.getElementById('year_chart').style.display = 'block';
					  
					//fill the innerHTML of each section
					document.getElementById('info').innerHTML = content;
					document.getElementById('source').innerHTML = source;
				});
			});
						 
			//add layer to map
			client.addLayer(layer_swc);
			
			//set pop-up content when hovering over a feature
			layer_swc.on('featureOver', featureEvent =>{
				let address = '';
				
				address += `<div class="widget">`;

				address += `<p class = "bold">${featureEvent.data.building} ${featureEvent.data.street}</p><p>${featureEvent.data.business_name2}</p><p>${featureEvent.data.business_name}</p>`;
				popup.setContent(address);
				popup.setLatLng(featureEvent.latLng);
				if (!popup.isOpen()) {
					popup.openOn(map);
				}
			});
			
			layer_swc.on('featureClicked', featureEvent => {
				//variables for the innerHTML content that will be filled into each div in the infobox
				let content = '';
				let source = '';
				
				//variables to check whether the license is under review or expired
				let under_review = false;
				let expired = false;
				
				//function to clear the previous 311 charts
				clear_charts();

				//check whether the selected sidewalk café permit is expired or under review
				if ((featureEvent.data.issuance == 'Pending Review') && (featureEvent.data.lic_status == 'Inactive')){
					 under_review = true;
					 expired = false;
				}
				
				else if ((featureEvent.data.issuance == 'Issued') && (featureEvent.data.lic_status == 'Inactive')){
					 under_review = false;
					 expired = true;
				}
				 
				content += `<h3 class = "bold">${featureEvent.data.business_name2}</h3>
				<h4 class = "bold">${featureEvent.data.business_name}</h4>
				<h4>${featureEvent.data.building} ${featureEvent.data.street}</h4><div class="separator"></div>`;
				
				//set content if under review
				if (under_review == true){
					 content += `<h5 class = "lighter">${featureEvent.data.issuance}</h5>
					 <h5 class = "lighter">Application ID: ${featureEvent.data.app_id}</h5>
					 <h5 class = "lighter">Application Type: ${featureEvent.data.app_swc_type}</h5>
					 <h5 class = "lighter">Application Square footage: ${featureEvent.data.app_sq_ft}</h5>
					 <h5 class = "lighter">Application Tables: ${featureEvent.data.app_tables}</h5>
					 <h5 class = "lighter">Application Chairs: ${featureEvent.data.app_chairs}</h5>
					 <h5 class = "lighter">Application Intake Date: ${featureEvent.data.intake_dd}</h5>
					 <h5><a href="https://www1.nyc.gov/assets/dca/SidewalkCafeMap/index.html#home" target="_blank">Click here for more information about this sidewalk cafe.</h5>`;
				}
				
				//set content if expired
				else if (expired == true){
					 content += `<h5 class = "lighter">Status: ${featureEvent.data.lic_status}</h5>
					 <h5 class = "lighter">License Number: ${featureEvent.data.license_nbr}</h5>
					 <h5 class = "lighter">Issuance Date: ${featureEvent.data.issuance_dd}</h5>
					 <h5 class = "lighter">Expiration Date: ${featureEvent.data.expiration_date}</h5>`;
				}
				
				//set content is active
				else
					 content += `<h5 class = "lighter">Status: ${featureEvent.data.lic_status}</h5>
					 <h5 class = "lighter">License Number: ${featureEvent.data.license_nbr}</h5>
					 <h5 class = "lighter">Type: ${featureEvent.data.swc_type}</h5>
					 <h5 class = "lighter">Square footage: ${featureEvent.data.swc_sq_ft}</h5>
					 <h5 class = "lighter">Tables: ${featureEvent.data.swc_tables}</h5>
					 <h5 class = "lighter">Chairs: ${featureEvent.data.swc_chairs}</h5>
					 <h5 class = "lighter">Issuance Date: ${featureEvent.data.issuance_dd}</h5>
					 <h5 class = "lighter">Expiration Date: ${featureEvent.data.expiration_date}</h5>
					 <div class="separator"></div>
					 <h5 class = "lighter">Community Board: ${featureEvent.data.community_district}</h5>
					 <h5 class = "lighter">Community Board Review Status: ${featureEvent.data.cb}</h5>
					 <h5 class = "lighter">Community Board Review Status Date: ${featureEvent.data.cb_dd}</h5>
					 <h5><a href="https://www1.nyc.gov/assets/dca/SidewalkCafeMap/index.html#home" target="_blank">Click here for more information about this sidewalk cafe.</h5>
					 `;
				
				//add source information
				source += `<div class="separator"></div><h6>Source: <a href='https://data.cityofnewyork.us/Business/Sidewalk-Caf-Licenses-and-Applications/qcdj-rwhu/data'>Sidewalk Cafe Licenses and Applications.</a></h6><h6>Data is updated weekly.</h6>`;
				
				//set the info_box to display as block
				show_info_box();
				
				//fill the innerHTML of each section
				document.getElementById('info').innerHTML = content;
				document.getElementById('source').innerHTML = source;
			});
			
			//add layer to map
			client.addLayer(layer_sla);
			
			//set pop-up content when hovering over a feature
			layer_sla.on('featureOver', featureEvent =>{
				let address = '';
				
				address += `<div class="widget">`;

				address += `<p class = "bold">${featureEvent.data.actual_address_of_premises_address1}</p><p>${featureEvent.data.doing_business_as_dba}</p><p>${featureEvent.data.premises_name}</p>`;
				popup.setContent(address);
				popup.setLatLng(featureEvent.latLng);
				if (!popup.isOpen()) {
					popup.openOn(map);
				}
			});
			
			layer_sla.on('featureClicked', featureEvent => {
				//variables for the innerHTML content that will be filled into each div in the infobox
				let content = '';
				let source = '';
				
				//variable to store BIN from city geoclient
				var bin = 0;
				
				//function to clear the previous 311 charts
				clear_charts();
				
				//check if dba is filled in; otherwise use premises name as the header
				if (featureEvent.data.doing_business_as_dba != '') {
					content += `<h3 class = "bold">${featureEvent.data.doing_business_as_dba}</h3><h4 class = "bold">${featureEvent.data.premises_name}</h4>`;
					}
				else {
					content += `<h3 class = "bold">${featureEvent.data.premises_name}</h3>`;
				}
				content+= `<h4>${featureEvent.data.actual_address_of_premises_address1}</h4><div class="separator"></div>
				<h5 class = "lighter">License Type: ${featureEvent.data.license_type_name}</h5>
				<h5 class = "lighter">Serial number: ${featureEvent.data.license_serial_number}</h5>
				<h5 class = "lighter">Original Issue Date: ${featureEvent.data.license_original_issue_date}</h5>
				<h5 class = "lighter">Effective Date: ${featureEvent.data.license_effective_date}</h5>
				<h5 class = "lighter">Expiration Date: ${featureEvent.data.license_expiration_date}</h5>
				<h5 class = "lighter"><a href= 'https://www.tran.sla.ny.gov/servlet/ApplicationServlet?pageName=com.ibm.nysla.data.publicquery.PublicQuerySuccessfulResultsPage&validated=true&serialNumber=${featureEvent.data.license_serial_number}&licenseType=OP' target = '_blank'>Click here for more information about this license.</a></h5>`;
				
				
				//adds CORS header to proxy request getting around errors
				const proxyurl = "https://cors-anywhere.herokuapp.com/";
				
				//Query the city's Geoclient API to get the BIN of the building at the address listed in the SLA data. we will use this to collect the Certificate of Occupancy
				var url = "https://api.cityofnewyork.us/geoclient/v1/search.json?input=" + featureEvent.data.actual_address_of_premises_address1 + " " + featureEvent.data.zip + "&app_id=dd37f663&app_key=c99663c5e8b11315279f8d28ef245dab";
				
				var slaBIN = new Promise(function(resolve) {
					fetch(proxyurl + url, {mode: 'cors'})
					.then(function(response) {
						return response.json();
					})
					.then(function(address) {
						results = address.results;
						response = results[0].response;
						bin = response.buildingIdentificationNumber;
						resolve(bin);
					})
					.catch(function(error) {
						bin = 0;
						resolve(bin);
					});
				});
				
				slaBIN.then(function(bin) {
					if (bin == 0){
						content += `<div class="separator"></div><h4>Certificate of Occupancy</h4>><h5 class = "lighter">No BIN Found.</h5>`;
					}
					//display a link to BISweb for the Certificate of Occupancy at that BIN
					else {
						certURL = "http://a810-bisweb.nyc.gov/bisweb/COsByLocationServlet?requestid=1&allbin=" + bin;
						content += `<div class="separator"></div><h4>Certificate of Occupancy</h4><h5 class = "lighter">BIN: <a href= '${certURL}' target = '_blank'>${bin}</a></h5>`;
					}
								
					//add source information
					source += `<div class="separator"></div><h6>Source: <a href='https://data.ny.gov/Economic-Development/Liquor-Authority-Quarterly-List-of-Active-Licenses/hrvs-fxs2'>Liquor Authority Quarterly List of Active Licenses.</a></h6><h6>Data is filtered to liquor licenses reviewed by the New York City Agency Office. Data is updated quarterly.</h6>`;
					//set the info_box to display as block
					show_info_box();
					
					//fill the innerHTML of each section
					document.getElementById('info').innerHTML = content;
					document.getElementById('source').innerHTML = source;
				});
			});
			
			//add layer to map
			client.addLayer(layer_dohmh);
			
			//set pop-up content when hovering over a feature
			layer_dohmh.on('featureOver', featureEvent =>{
				let address = '';
				
				address += `<div class="widget">`;

				address += `<p class = "bold">${featureEvent.data.building} ${featureEvent.data.street}</p><p>${featureEvent.data.dba}</p>`;
				popup.setContent(address);
				popup.setLatLng(featureEvent.latLng);
				if (!popup.isOpen()) {
					popup.openOn(map);
				}
			});
			
			layer_dohmh.on('featureClicked', featureEvent => {
				//variables for the innerHTML content that will be filled into each div in the infobox
				let content = '';
				let source = '';
				
				//function to clear the previous 311 charts
				clear_charts();
					
				content += `<h3 class = "bold">${featureEvent.data.dba}</h3>
				<h4>${featureEvent.data.building} ${featureEvent.data.street}</h4><div class="separator"></div>`;

				//query restaurant health inspection results dataset (stored in carto) to collect all of the inspection data about the selected restaurant; order from the most recent inspection to the oldest inspection
				var url = "https://betanyc.carto.com/api/v2/sql/?q=SELECT * FROM dohmh_new_york_city_restaurant_inspection_results WHERE camis='"+featureEvent.data.camis+"' ORDER BY to_timestamp(grade_date, 'MM/DD/YYYY') DESC&api_key="+api_key;
				fetch(url)
				.then(function(response) {
					return response.json();
				})
				.then(function(camis_data) {
					//show the date and grade of the most recent inspection
					if (camis_data.rows.length != 0){
						content += `
						<h5 class = "lighter">Most Recent Grade: ${camis_data.rows[0].grade}</h5>
						<h5 class = "lighter">Grade Date: ${camis_data.rows[0].grade_date}</h5>`;
					}
					
					//DOHMH data has a different row for every flag raised in an inspection for every restaurant in the city. This means that for a given inspection, resulting in one grade, the restaurant may have several rows in the dataset, each having the same grade date and grade, but listing different flags that were raised. To deal with, we need to group the data about the inspection results for a restaurant by its grade date, and store the data in an array. Then we can loop through that array and select the first grade for each grade date. (every grade will be the same on a given grade date, so it doesn't necessarily have to be the first element. But we don't know how many rows there will be for each grade date, so the first element is safest.
					Array.prototype.groupBy = function(prop) {
					  return this.reduce(function(groups, item) {
						const val = item[prop]
						groups[val] = groups[val] || []
						groups[val].push(item)
						return groups
					  }, {})
					}
					var grade_history = camis_data.rows.groupBy('grade_date');

					content += `<div class="separator"></div><h5 class = "bold">Grade History</h5>`;
					//show the first grade for each grade date in the array; (they should all be the same)
					for (var i = 0; i < Object.keys(grade_history).length; i++) {
						var key = Object.keys(grade_history)[i];
						var values = Object.values(grade_history)[i];
						if (key != '') {
							content += `<h5 class = "lighter"> ${key}: ${values[0].grade}</h5>`;
						}
					}
					content += `<h5><a href="http://a816-restaurantinspection.nyc.gov/RestaurantInspection/SearchBrowse.do" target="_blank">Click here for more information about this restaurant.</h5> `;
					
					//add source information
					source += `<div class="separator"></div><h6>Source: <a href='https://data.cityofnewyork.us/Health/DOHMH-New-York-City-Restaurant-Inspection-Results/43nn-pn8j/data'>DOHMH New York City Restaurant Inspection Results.</a></h6><h6>Data is geocoded with the Department of City Planning's GeoSupport application once a week. The map does not display restaurants with addresses rejected by the application. Data is updated weekly.</h6>`;
				
				//set the info_box to display as block
				show_info_box();
				
				//fill the innerHTML of each section
				document.getElementById('info').innerHTML = content;
				document.getElementById('source').innerHTML = source;
				});

			});

            client.getLeafletLayer().addTo(map);
            
            const popup = L.popup({ closeButton: false });
			
		</script>
    </body>
</html>

